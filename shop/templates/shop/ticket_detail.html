{% extends "shop/base.html" %}
{% block title %}工单 #{{ ticket.pk }}{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>工单 #{{ ticket.pk }}: {{ ticket.subject }}</h1>
    <span class="badge bg-{% if ticket.status == 'OPEN' %}success{% elif ticket.status == 'IN_PROGRESS' %}info{% else %}secondary{% endif %}">{{ ticket.get_status_display }}</span>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      {{ ticket.description|linebreaks }}
      <p class="text-muted mt-2">由 {{ ticket.user.username }} 创建于 {{ ticket.created_at|date:"Y-m-d H:i" }}</p>
    </div>
  </div>

  <h4>对话记录</h4>
  {% for message in ticket.messages.all %}
    <div class="card mb-3 {% if message.user == ticket.user %}ms-5{% else %}me-5 bg-light{% endif %}">
      <div class="card-body">
        <p>{{ message.message|linebreaks }}</p>
        <p class="text-muted small mb-0 text-end">- {{ message.user.username }} at {{ message.created_at|date:"Y-m-d H:i" }}</p>
      </div>
    </div>
  {% empty %}
    <p>暂无回复。</p>
  {% endfor %}

  <hr>

  <h4>回复工单</h4>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">发送回复</button>
  </form>

  {% if request.user.is_superuser or is_merchant %}
    <hr>
    <h4>管理操作</h4>
    <form method="post" action="{% url 'shop:ticket_update_status' ticket.pk %}">
      {% csrf_token %}
      <div class="input-group">
        <select name="status" class="form-select">
          <option value="OPEN" {% if ticket.status == 'OPEN' %}selected{% endif %}>待处理</option>
          <option value="IN_PROGRESS" {% if ticket.status == 'IN_PROGRESS' %}selected{% endif %}>处理中</option>
          <option value="CLOSED" {% if ticket.status == 'CLOSED' %}selected{% endif %}>已关闭</option>
        </select>
        <button type="submit" class="btn btn-secondary">更新状态</button>
      </div>
    </form>
  {% endif %}
{% endblock %}
