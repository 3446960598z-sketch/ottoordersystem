{% extends "shop/base.html" %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'shop/css/product_detail.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4 product-detail-container">
  <div class="row product-main-section">
    <div class="col-md-6 product-image-wrapper">
      {% if product.image %}
        <img src="{{ product.image.url }}" class="img-fluid product-image" alt="{{ product.name }}">
      {% else %}
        <img src="{% static 'shop/images/default_product.png' %}" class="img-fluid product-image" alt="暂无图片">
      {% endif %}
    </div>
    <div class="col-md-6 product-info-card">
      <h2 class="product-title">{{ product.name }}</h2>
      <p class="product-price">价格: <span class="fw-bold text-danger">¥{{ product.price }}</span></p>
      <p class="product-status">状态: 
        {% if product.is_active %}
          <span class="badge bg-success product-badge">上架中</span>
        {% else %}
          <span class="badge bg-danger product-badge">已下架</span>
        {% endif %}
      </p>
      <p class="product-stock">库存: 
        {% if product.stock > 0 %}
          <span class="badge bg-info product-badge">{{ product.stock }}</span>
        {% else %}
          <span class="badge bg-warning product-badge">售罄</span>
        {% endif %}
      </p>
      <p class="product-description">{{ product.description|default:"暂无商品描述" }}</p>

      {% if request.user.shop_account and request.user.shop_account == product.shop %}
        <div class="mb-3 product-owner-actions">
          <a href="{% url 'shop:product_edit' product.pk %}" class="btn btn-secondary product-action-btn">编辑商品</a>
          <form action="{% url 'shop:product_toggle' product.pk %}" method="post" class="d-inline ms-2">
            {% csrf_token %}
            <button type="submit" class="btn {% if product.is_active %}btn-danger{% else %}btn-success{% endif %} product-action-btn">
              {% if product.is_active %}下架{% else %}上架{% endif %}
            </button>
          </form>
        </div>
      {% endif %}

      <div class="d-flex align-items-center gap-2">
        <form method="post" action="{% url 'shop:add_to_cart' product.pk %}" class="add-to-cart-form flex-grow-1">
            {% csrf_token %}
            <div class="input-group">
              <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" class="form-control quantity-input" style="max-width: 80px;" {% if not product.is_active or product.stock == 0 %}disabled{% endif %}>
              <button type="submit" class="btn btn-primary add-to-cart-btn" value="{{ product.pk }}" {% if not product.is_active or product.stock == 0 %}disabled{% endif %}>
                  <i class="bi bi-cart-plus-fill me-2"></i>加入购物车
              </button>
            </div>
        </form>
        
        {% if user.is_authenticated %}
        <form action="{% url 'shop:toggle_favorite' product.id %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn {% if is_favorited %}btn-danger{% else %}btn-outline-danger{% endif %}">
                <i class="bi {% if is_favorited %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                {% if is_favorited %} 已收藏{% else %} 收藏{% endif %}
            </button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  <hr class="my-4 product-divider">

  <div class="row product-reviews-section">
    <div class="col-12">
      <h3 class="reviews-title">商品评价</h3>
      {% if reviews %}
        <div class="list-group reviews-list-group">
          {% for review in reviews %}
            <div class="list-group-item review-item">
              <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                <h5 class="mb-0 review-username">{{ review.user.username }}</h5>
                <small class="text-muted review-date">{{ review.created_at|date:"Y-m-d" }}</small>
              </div>
              <p class="mb-1 review-rating">评分: <span class="text-warning fw-bold">{{ review.rating }}/5</span></p>
              <p class="mb-0 review-comment">{{ review.comment|default:"用户没有留下文字评价。" }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="card text-center p-4 no-reviews-card">
            <p class="text-muted mb-0">该商品暂无评价。</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
