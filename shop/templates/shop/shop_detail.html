{% extends "shop/base.html" %}
{% load static %}
{% block title %}{{ shop.name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'shop/css/shop_detail.css' %}">
{% endblock %}

{% block content %}
<div class="card mb-4 shadow-sm rounded-4 overflow-hidden shop-header">
    <div class="card-body p-4">
        <h1 class="card-title fw-bold">{{ shop.name }}</h1>
        <div class="d-flex align-items-center mb-2">
            <span class="badge bg-warning text-dark me-2">
              <i class="bi bi-star-fill"></i> {{ shop.rating_avg|floatformat:1 }}
            </span>
            <span class="text-muted small">({{ shop.rating_count }} 人评价)</span>
        </div>
        <p class="card-text text-muted">{{ shop.description|default:"店主很懒，什么都没留下..." }}</p>
    </div>
</div>

<!-- Category Tabs -->
{% if categories %}
<ul class="nav nav-tabs mb-4" id="categoryTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="all-tab" data-category-id="all">全部商品</button>
  </li>
  {% for category in categories %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="category-{{ category.id }}-tab" data-category-id="{{ category.id }}">{{ category.name }}</button>
  </li>
  {% endfor %}
</ul>
{% endif %}

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  {% for product in products %}
    <div class="col product-card" data-category-id="{{ product.category.id|default:'none' }}">
      <div class="card h-100 rounded-4 shop-card">
        <div class="img-container">
            <a href="{% url 'shop:product_detail' product.pk %}">
                {% if product.image %}
                  <img src="{{ product.image.url }}" class="card-img-top shop-card-img" alt="{{ product.name }}">
                {% else %}
                  <img src="{% static 'shop/images/default_product.png' %}" class="card-img-top shop-card-img" alt="Default product image">
                {% endif %}
            </a>
        </div>
        <div class="card-body">
          <h5 class="card-title fw-bold">
              <a href="{% url 'shop:product_detail' product.pk %}" class="text-decoration-none text-dark stretched-link">{{ product.name }}</a>
          </h5>
          <p class="card-text text-danger fw-bold fs-5">¥{{ product.price }}</p>
        </div>
        <div class="card-footer">
            <form class="d-grid add-to-cart-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-gradient fw-semibold" value="{{ product.id }}">
                    <i class="bi bi-cart-plus-fill me-2"></i>加入购物车
                </button>
            </form>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
        <div class="card text-center p-5 rounded-4">
            <p class="text-muted">该店铺暂无商品，敬请期待！</p>
        </div>
    </div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const categoryTabs = document.querySelectorAll('#categoryTabs .nav-link');
    const productCards = document.querySelectorAll('.product-card');

    categoryTabs.forEach(tab => {
        tab.addEventListener('click', function () {
            const categoryId = this.getAttribute('data-category-id');
            
            categoryTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            productCards.forEach(card => {
                const productCategoryId = card.getAttribute('data-category-id');
                const shouldBeVisible = (categoryId === 'all' || categoryId === productCategoryId);
                
                if (shouldBeVisible) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        });
    });
});
</script>
{% endblock %}
